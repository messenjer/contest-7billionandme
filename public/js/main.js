// Generated by CoffeeScript 1.3.3
var Population;

Population = (function() {

  function Population() {
    var _this = this;
    this.initialPopulation = null;
    this.currentPopulation = null;
    this.wantedDate = null;
    this.handlerList = {
      'compute': $('.app-compute'),
      'wantedDate': $('.app-wantedDate'),
      'wantedPopulation': $('.app-wantedPopulation'),
      'currentPopulation': $('.app-currentPopulation')
    };
    this.handlerList['compute'].click(function(e) {
      var wantedDate, wantedPopulation, wantedTimestamp;
      e.preventDefault();
      wantedDate = _this.handlerList['wantedDate'].prop('value');
      wantedDate = wantedDate.replace(/(\d{2})\/(\d{2})\/(\d{4})(.*)/, "$2/$1/$3$4");
      wantedTimestamp = new Date(wantedDate).getTime() / 1000;
      wantedPopulation = _this.getWantedPopulation(wantedTimestamp);
      return _this.handlerList['wantedPopulation'].html(_this.formatNumber(wantedPopulation));
    });
  }

  Population.prototype.getPopulation = function() {
    var _this = this;
    return $.getJSON('/population', function(data) {
      var callback;
      _this.currentPopulation = data;
      if (_this.initialPopulation === null) {
        _this.initialPopulation = _this.currentPopulation;
      }
      _this.handlerList['currentPopulation'].html(_this.formatNumber(_this.currentPopulation['population']));
      callback = function() {
        return _this.getPopulation();
      };
      return setTimeout(callback, 5000);
    });
  };

  Population.prototype.getWantedPopulation = function(wantedTimestamp) {
    var growth, p1, p2, t1, t2, wantedPopulation;
    if (this.initialPopulation !== null && this.currentPopulation !== null) {
      t1 = this.initialPopulation['timestamp'];
      t2 = this.currentPopulation['timestamp'];
      p1 = this.initialPopulation['population'];
      p2 = this.currentPopulation['population'];
      growth = (p2 - p1) / (t2 - t1);
      wantedPopulation = Math.floor(p1 + ((wantedTimestamp - t1) * growth));
      console.log('Population increase of ' + (p2 - p1) + ' people in ' + (t2 - t1));
      console.log('Growth is ' + growth);
      console.log('Wanted date is ' + this.formatDate(wantedTimestamp));
      console.log('Population should be ' + wantedPopulation + '(+' + (wantedPopulation - p1) + ') in ' + (wantedTimestamp - t1) + ' seconds');
    }
    return wantedPopulation;
  };

  Population.prototype.formatDate = function(timestamp) {
    var date, day, formatDate, hour, minute, month, second, year;
    date = new Date(timestamp * 1000);
    day = date.getDate() < 10 ? '0' + date.getDate() : date.getDate();
    month = date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1;
    year = date.getFullYear();
    hour = date.getHours() < 10 ? '0' + date.getHours() : date.getHours();
    minute = date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes();
    second = date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds();
    return formatDate = "" + day + "/" + month + "/" + year + " " + hour + ":" + minute + ":" + second;
  };

  Population.prototype.formatNumber = function(number) {
    return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  };

  return Population;

})();

$(function() {
  var population;
  population = new Population();
  population.getPopulation();
  $('input').datepicker({
    format: 'dd/mm/yyyy hh:ii:ss',
    weekStart: 1
  });
  return true;
});
